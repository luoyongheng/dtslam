%%
clear 
frameA(1)=37
frameB(1)=300
matchCount(1)=605
Ra{1}=[0.89451593, -0.024197616, 0.44638073;
 0.023340316, 0.99970007, 0.0074198381;
 -0.44642636, 0.0037815038, 0.89481241]
Ta{1}=[0.672702, 0.0125327, 0.768943]
Rb{1}=[0.62029409, -0.005092124, -0.78435284;
 -0.028013198, 0.99919719, -0.028640755;
 0.78386897, 0.039737921, 0.6196534]
Tb{1}=[-1.5636, 0.199996, 0.218261]
Rc{1}=[0.99264169, -0.002157165, -0.1210693;
 0.0016355327, 0.99998897, -0.004407749;
 0.12107747, 0.0041773031, 0.9926343]
Tc{1}=[1.32877, 0.0589673, 0.0593731]

frameA(2)=0
frameB(2)=350
matchCount(2)=830
Ra{2}=[0.96200514, -0.010791949, 0.27281797;
 0.0092210975, 0.99993271, 0.0070394166;
 -0.27287558, -0.0042562736, 0.96203995]
Ta{2}=[-0.617911, -0.0381885, 0.988552]
Rb{2}=[0.48299497, -0.0005680421, -0.87562293;
 -0.044869617, 0.99866992, -0.025398016;
 0.87447274, 0.05155598, 0.4823271]
Tb{2}=[-2.73846, 0.269017, 0.0828231]
Rc{2}=[1, -0, 0;
 0, 1, -0;
 -0, 0, 1]
Tc{2}=[0, 0, 0]

frameA(3)=0
frameB(3)=333
matchCount(3)=749
Ra{3}=[0.94948, -0.015389565, 0.31345004;
 0.014604175, 0.99988157, 0.0048536323;
 -0.31348762, -3.0747524e-005, 0.94959229]
Ta{3}=[-0.0883391, -0.0111444, 0.840596]
Rb{3}=[0.51528031, -0.0032027075, -0.85701573;
 -0.037774056, 0.99893636, -0.026444707;
 0.85618883, 0.045999397, 0.51461124]
Tb{3}=[-2.25906, 0.23592, 0.0124363]
Rc{3}=[1, -0, 0;
 0, 1, -0;
 -0, 0, 1]
Tc{3}=[0, 0, 0]

frameA(4)=0
frameB(4)=316
matchCount(4)=629
Ra{4}=[0.93564737, -0.016948869, 0.35252911;
 0.016009955, 0.99985629, 0.0055790059;
 -0.35257301, 0.00042399313, 0.93578422]
Ta{4}=[0.297965, -0.00753177, 0.751536]
Rb{4}=[0.55109447, -0.0022401079, -0.83443987;
 -0.037728216, 0.99890685, -0.027598718;
 0.83358949, 0.046691429, 0.55040753]
Tb{4}=[-1.94019, 0.241151, 0.0246093]
Rc{4}=[1, -0, 0;
 0, 1, -0;
 -0, 0, 1]
Tc{4}=[0, 0, 0]
Rrel=[0.20486617, 0.0035674926, -0.97878355;
 -0.062021121, 0.99803114, -0.0093438048;
 0.97682303, 0.062619478, 0.20468405]
scale=1.02707
t=[-1.83663, 0.316641, -1.51055]

for i=1:length(Rb); pb(:,i)=-Rb{i}'*Tb{i}'; end
for i=1:length(Ra); pa(:,i)=-Ra{i}'*Ta{i}'; end

%%
R = Rb{1}*Ra{1}';
pbb = R*pb;

mbb = mean(pbb,2);
ma = mean(pa,2);

pbb0 = bsxfun(@minus,pbb,mbb);
pa0 = bsxfun(@minus,pa,ma);

s=mean(sum(pa0.^2).^0.5./sum(pbb0.^2).^0.5)

t=mean(pa,2)-mean(pbb,2)*s

pf = bsxfun(@plus, s*R*pb, t);
figure;
plotAlignedPoints(pf,pa)
title('Sequential');

%%
[s,R,t,pf] = nonlinearOrientation(pb,pa);
figure;
plotAlignedPoints(pf,pa)
title('nonlinear');