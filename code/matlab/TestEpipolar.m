%%
% Generate data
imageSize = [1920, 1080];
K = [1759.95830,   0, 963.80029; 0, 1758.22390, 541.04811; 0 0 1];
kc = [0.16262,-0.67445];

R1 = eye(3);
t1 = zeros(3,1);

R2 = eye(3);
t2 = [-0.1,0,0]';

R3 = eye(3);
t3 = [-0.05,-0.05,0]';

[xx,yy] = meshgrid(-0.1:0.01:0.1, -0.1:0.01:0.1);
X = zeros(3,length(xx(:)));
X(1,:) = xx(:);
X(2,:) = yy(:);
X(3,:) = [2.798482,2.014500,3.353150,3.687618,2.277719,3.994435,3.492306,2.886525,3.363378,3.948490,1.537966,2.299885,2.247268,3.891759,1.322652,3.433787,2.378578,2.876854,3.361586,3.774106,3.783341,3.970204,3.761017,2.293384,3.333013,2.257670,2.991558,1.586320,1.520895,3.869369,3.955110,3.824133,1.904420,3.779864,2.591752,3.580812,1.818835,3.827731,2.559745,2.444528,1.807949,2.871150,3.866179,2.313240,3.617269,3.104229,2.431847,2.168199,2.177650,1.499974,2.155230,1.734626,3.431699,1.951543,2.684025,1.878231,3.418093,1.553643,1.062818,2.143157,1.385424,1.076985,2.266225,3.557213,1.532400,1.339492,1.401857,1.458524,2.571350,2.495321,2.696793,2.329081,2.255122,3.394713,2.162968,2.733565,2.066584,2.366660,2.190661,1.444065,1.477649,1.062210,2.399149,2.592505,2.640339,1.126517,3.434680,2.961231,2.778877,3.162136,2.190939,1.644815,2.880106,3.460283,2.711047,3.113407,3.170106,2.917215,2.637687,1.382589,1.050272,2.723314,2.213937,3.753775,1.348866,2.657853,1.735275,1.528109,3.782528,1.370611,3.406413,2.019532,1.319075,2.068677,3.592534,2.080671,3.796143,3.258513,2.931795,3.723774,2.002912,2.198158,3.089986,1.732471,1.948692,3.121891,2.587884,3.940151,2.096440,2.859522,3.640804,2.598802,1.374143,3.431132,2.326960,2.287046,1.436471,1.664129,2.135952,2.886217,3.079359,2.040923,3.137226,1.647930,2.842946,2.426387,2.022535,3.234606,3.009023,2.671457,3.183439,3.805732,1.790550,1.567857,1.811110,1.444817,1.493083,3.398078,1.678729,1.200544,1.600469,3.751470,1.900598,2.558642,3.947928,2.563301,2.702758,1.669081,2.111923,2.517519,2.368185,3.781098,3.140817,3.012864,1.493420,1.423962,2.023516,1.043481,2.635291,2.116048,3.840602,3.229735,1.343564,1.973576,2.837414,2.442466,1.544169,1.632083,1.535002,3.967138,2.533695,3.999790,1.688543,3.985377,3.446149,1.507980,3.383013,2.128979,2.512138,1.567559,3.013174,3.329411,1.420748,1.095672,2.696682,3.084899,3.252678,3.058972,2.493870,2.322476,3.769447,1.986225,2.618707,2.695265,2.045382,3.897523,2.491046,3.644576,2.475299,3.140876,2.137617,3.659367,3.233333,3.603933,1.746087,3.798049,1.073141,3.350485,1.463978,1.219765,3.566772,2.626813,2.557344,1.424682,1.200686,1.624787,2.033520,2.713106,3.500932,3.844095,2.638580,3.678475,3.408265,1.430098,2.228188,1.525626,2.549987,1.076671,3.347789,2.913646,2.592468,1.399181,1.820860,3.899543,2.552987,2.494455,1.856038,1.962448,3.780781,3.447513,3.493980,3.782191,3.289743,3.135823,1.035151,2.127386,3.814493,2.535074,2.130524,2.745085,1.231219,2.270647,3.259524,2.667303,1.438692,1.583645,3.836401,3.320476,3.336596,2.646331,3.073053,2.251782,3.124792,2.989104,1.161765,3.368711,1.871973,1.330342,3.653779,2.745956,2.874413,1.348697,1.710764,3.978354,3.563201,3.730696,3.005443,3.344704,3.736834,1.593550,3.150996,1.640197,3.129849,3.194344,2.333636,3.597399,3.317271,1.582865,2.287111,1.228793,1.517528,2.752910,1.981410,3.475269,3.227962,1.022543,3.306445,1.477473,2.752049,3.957668,1.029506,2.290109,2.348166,1.215419,2.467162,1.261013,3.187767,1.996924,2.370194,2.426099,2.430989,2.133121,3.997867,2.948227,1.179852,1.542229,2.147583,2.517782,3.687980,1.853828,2.736883,3.978109,3.801282,2.625252,3.200326,3.722859,3.795443,1.841560,3.208959,2.174932,3.348119,1.064035,1.254968,1.728247,1.841673,1.841010,1.981592,3.095119,1.946259,3.692520,2.831354,1.616340,3.842251,2.726377,1.424034,1.980412,2.057830,2.714767,3.081173,2.375530,1.886454,3.271355,3.953097,2.354082,1.636899,2.975699,1.482768,3.107941,2.733217,1.852984,1.102592,1.735286,2.970944,1.757556,2.402700,3.439003,1.934551,1.552451,2.679763,1.661621,1.585457,1.934275,2.958342,2.121249,3.476230,2.453772,3.606967,2.826467,3.537940,1.108154,2.307948,3.679510,1.908587,2.012486,2.497789,1.908905,1.568204,2.916556,2.939544,1.090391,2.763130,2.976462,1.212166,3.646881,3.126785,2.529043,3.454319,1.170460,1.794040,1.718506,3.373311,1.581985,3.555613,3.997359,2.683511,2.116902,3.982658,2.916764,2.350452,3.232838,1.743745,3.437463,2.380709,3.216818,2.645597,2.702251,3.664469,1.650084,2.837388,1.656498,3.294563];

xc1 = bsxfun(@plus,R1*X,t1);
m1 = projectFromWorld(K,kc,xc1);

xc2 = bsxfun(@plus,R2*X,t2);
m2 = projectFromWorld(K,kc,xc2);

xc3 = bsxfun(@plus,R3*X,t3);
m3 = projectFromWorld(K,kc,xc3);

fprintf('R1: {');
fprintf('%f,',R1);
fprintf('}\n')

fprintf('t1: {');
fprintf('%f,',t1);
fprintf('}\n')

fprintf('R2: {');
fprintf('%f,',R2);
fprintf('}\n')

fprintf('t2: {');
fprintf('%f,',t2);
fprintf('}\n')

fprintf('R3: {');
fprintf('%f,',R3);
fprintf('}\n')

fprintf('t3: {');
fprintf('%f,',t3);
fprintf('}\n')

fprintf('X:');
fprintf('{');
fprintf('%f,',X);
fprintf('}\n')

fprintf('m1:');
fprintf('{');
fprintf('%f,',m1);
fprintf('}\n')

fprintf('m2:');
fprintf('{');
fprintf('%f,',m2);
fprintf('}\n')

fprintf('m3:');
fprintf('{');
fprintf('%f,',m3);
fprintf('}\n')

sigma = 1;
m1_noise = m1 + sigma * randn(size(m1));
m2_noise = m2 + sigma * randn(size(m2));
m3_noise = m3 + sigma * randn(size(m3));

fprintf('std::vector<float> m0v = ');
fprintf('{');
fprintf('%f,',m1_noise);
fprintf('};\n')

fprintf('std::vector<float> m1v = ');
fprintf('{');
fprintf('%f,',m2_noise);
fprintf('};\n')

fprintf('std::vector<float> m2v = ');
fprintf('{');
fprintf('%f,',m3_noise);
fprintf('};\n')

fprintf('Range m1_noise: %f,%f\n', min(m1_noise(:)), max(m1_noise(:)));
fprintf('Range m2_noise: %f,%f\n', min(m2_noise(:)), max(m2_noise(:)));
fprintf('Range m3_noise: %f,%f\n', min(m3_noise(:)), max(m3_noise(:)));

%%
% Test epipolar
Rtest = R3;
ttest = t3;
xct = bsxfun(@plus,Rtest*X,ttest);

Rrel = Rtest * R1';
trel = ttest - Rrel*t1;
epipole = trel
E = SkewSymmetric(trel)*Rrel

xn1 = xc1(:,1)/xc1(3,1)
line=E*xn1
lineNormSq = line(1)^2+line(2)^2

xnt = xct(:,1)/xct(3,1)
dist = xnt'*line/lineNormSq.^0.5